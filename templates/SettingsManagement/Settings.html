{% extends 'shared/layout.html'%}

{% block header %}
<title>Settings</title>
<link rel="stylesheet" href="{{ url_for('static', filename='lib/leafletMap/leaflet.css') }}""/>
<script src="{{ url_for('static', filename='lib/leafletMap/leaflet.js') }}"></script>
<script src="{{ url_for('static', filename='lib/leafletMap/Control.OSMGeocoder.js') }}"></script>
<style>
    #Password {
        text-security:disc;
        -webkit-text-security:disc;
        -mox-text-security:disc;
    }
</style>
{% endblock %}
{% block content %}
<div id="accordion">
    <h3>Application Settings</h3>
    <div>
        <div class="form-horizontal">
            <div class="form-group row">
                <div class="col-md-2" >
                    <label>Server</label>
                </div>
                <div class="col-md-4" >
                    <input type="text" class="form-control" id="Server" name="Server" value="{{ settings.server }}"/>
                </div>
                <div class="col-md-2" >
                    <label>Port</label>
                </div>
                <div class="col-md-4" >
                    <input type="text" class="form-control" id="Port" name="Port" value="{{ settings.port }}"/>
                </div>
            </div>
        </div>
    </div>
    <h3>Database Settings</h3>
    <div>
        <div class="form-horizontal">
            <div class="form-group row">
                <div class="col-md-2" >
                    <label>Host</label>
                </div>
                <div class="col-md-4" >
                    <input type="text" class="form-control" id="Host" name="Host" value="{{ settings.host }}"/>
                </div>
                <div class="col-md-2" >
                    <label>Database</label>
                </div>
                <div class="col-md-4" >
                    <input type="text" class="form-control" id="Database" name="Database" value="{{ settings.database }}"/>
                </div>
            </div>
            <div class="form-group row">
                <div class="col-md-2" >
                    <label>User</label>
                </div>
                <div class="col-md-4" >
                    <input type="text" class="form-control" id="User" name="User" value="{{ settings.user }}"/>
                </div>
                <div class="col-md-2" >
                    <label>Password</label>
                </div>
                <div class="col-md-4" >
                    <input type="text" class="form-control" id="Password" name="Password" value="{{ settings.password }}"/>
                </div>
            </div>
        </div>
    </div>
    <h3>Organization Profile</h3>
    <div>
        <div class="form-horizontal">
            <div class="form-group row">
                <div class="col-md-2" >
                    <label>Organization Name</label>
                </div>
                <div class="col-md-4" >
                    <input type="text" class="form-control" id="OrganizationName" name="OrganizationName" value="{{ settings.organizationName }}"/>
                </div>
            </div>
            <div class="form-group row">
                <div class="col-md-12" >
                    <div id="mapid" style="width: 100%; height: 400px;"></div>
                    <input type="hidden" id="Latitude" value="{{ settings.latitude }}"/>
                    <input type="hidden" id="Longitude" value="{{ settings.longitude }}""/>
                </div>
            </div>
        </div>
    </div>
    <h3>Hometown Area</h3>
    <div>
        <div class="form-horizontal">
            <div class="form-group row">
                <div class="col-md-12" >
                    <div id="mapid2" style="width: 100%; height: 400px;"></div>
                </div>
            </div>
            <div class="form-group row">
                <div class="col-md-12" >
                    <input id='btnClearHomeTownArea' type="button" class="btn btn-primary" value="Clear"/>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="form-horizontal">
    <div class="form-group row">
        <div class="col-md-12" >
            <input id='btnSave' type="button" class="btn btn-primary" value="Save"/>
        </div>
    </div>
</div>
<script src="{{ url_for('static', filename='js/settings.js') }}"></script>
<script>
    $(function(){
        $( "#accordion" ).accordion({ heightStyle: "content"});
    });
    $(document).on("click", "#btnSave", function () {
        SaveSettings($('#Server').val(), $('#Port').val(), $('#Host').val(), $('#Database').val(), $('#User').val(), $('#Password').val(), $('#OrganizationName').val(), $('#Latitude').val(), $('#Longitude').val(),hometownArea);
        setTimeout(function() {
            open('http://'+$('#Server').val()+':'+$('#Port').val()+'/SettingsManagement/Settings', '_self');
        }, 2000);
    });

    var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    var osmAttrib='Falcon Leave Management System';
    var osm = new L.TileLayer(osmUrl, {attribution: osmAttrib});
    var mymap = new L.Map('mapid').addLayer(osm).setView([parseFloat($('#Latitude').val()), parseFloat($('#Longitude').val())], 18);
    var osmGeocoder = new L.Control.OSMGeocoder();
    var markerGroup = L.layerGroup().addTo(mymap);
    mymap.panTo(new L.LatLng(parseFloat($('#Latitude').val()), parseFloat($('#Longitude').val())));
    markerGroup.clearLayers();
    var marker = L.marker([parseFloat($('#Latitude').val()), parseFloat($('#Longitude').val())]).addTo(markerGroup);

    function onMapClick(e) {
        markerGroup.clearLayers();
        var marker = L.marker(e.latlng).addTo(markerGroup);
        $('#Latitude').val(e.latlng.lat);
        $('#Longitude').val(e.latlng.lng);
    }

    mymap.on('click', onMapClick);


    var osm2 = new L.TileLayer(osmUrl, {attribution: osmAttrib});
	var mymap2 = new L.Map('mapid2').addLayer(osm2).setView([parseFloat($('#Latitude').val()), parseFloat($('#Longitude').val())], 10);
    var osmGeocoder2 = new L.Control.OSMGeocoder();

    mymap2.addControl(osmGeocoder2);
    var markerGroup2 = L.layerGroup().addTo(mymap2);

    var hometownArea = {{ hometown|tojson|safe }};

    var area = L.polygon(hometownArea, 
    {
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.1
    }).addTo(markerGroup2);
    
    function onMapClick2(e) {
        markerGroup2.clearLayers();
        hometownArea.push([e.latlng.lat, e.latlng.lng]);
        var area = L.polygon(hometownArea, 
        {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.1
        }).addTo(markerGroup2);
    }

    mymap2.on('click', onMapClick2);

    $(document).on("click", "#btnClearHomeTownArea", function () {
        markerGroup2.clearLayers();
        hometownArea = [];
    });
</script>
{% endblock %}